---
title: "Project 3: EDA"
author: "Ignacio Toledo"
date: "03/15/2015"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
---

# Introduction

For this project the data from the **"VII Encuesta de Presupuestos Familiares"**
(VII Household Budget Survey) was selected. This is a survey done every 2 to 3
years in Chile, that contains data about household's inhabitants, some of their
social characteristics as income, education, gender, age, etc., and the expenses
each household have within a month. The data is splited in two data sets, one
with the inhabitant description and income variables, with some groupping 
categories by households (`households`); the other with the expenses reported 
in several categories by household id (`expenses`).

Some data wrangling will be needed before starting some of the exploratory data
analysis,  given that the `households` data set have one entry by each household
member,  while the `expenses` data set contains the expenses only by household 
not separated by household inhabitant: this means that is possible to  merge the
data by matching the household ids, but not by individuals.

# Loading libraries and data set {#load}

The following libraries were used for this work:

* `ggplot2`
* `gridExtra`
* `GGally`
* `ggthemes`
* `dplyr`
* `tidyr`
* `knitr`

```{r libraries, message=FALSE, echo=F}
library(ggplot2)
library(ggthemes)
library(GGally)
library(dplyr)
library(gridExtra)
library(tidyr)
library(knitr)
library(pander)
library(xtable)

theme_set(theme_bw())
```

The data is stored in RData files, after being transformed from SPSS data sets.

```{r load_data}
load("households.RData")
load("expenses.RData")
load("education.RData")
```

Some cleaning is still needed, for example there two negative ages and some
households without a total income reported, because of missing data.

```{r clean_data}
households <- subset(households, age > 0 & !is.na(INGDHOG_HD_AI))
```

# Univariate Analysis.

Let's start with some simple explorations of the population in our data set. 
What is the population's age distribution? The `summary` function can give us
a start:

```{r age_sum}
summary(households[,'age'])
```

The next figure shows an histogram using the `age` variable (a discrete 
numerical variable). The binwidths are equal to 1 year. The figure shows that
the population is not normally distributed and positevely skewed overall. This
is expected, since the population must decrese with age as people dies by
accidents, illness or natural causes. 

However is interesting to notice some peaks at around 5, 25 and 50 years of age:
they might correspond to generations with higher natallity rates or less infant
mortality.


```{r age_hist, fig.align = 'center', echo = F}
# A negative age is removed
age_hist <- ggplot(aes(age), data = subset(households, age >= 0))

age_hist + 
  geom_histogram(binwidth = 1, fill = "#67a9cf", color = "grey") +
  xlab("Age") +
  ylab("Freq.") +
  ggtitle("Age Distribution")
```


What about the education attainment distribution?

```{r eduatt, fig.align='center', echo=F}
edugen_plot <- ggplot(aes(edu.level), data = households)

edugen_plot + 
  geom_histogram(fill = "#67a9cf") + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) +
  xlab("Educational Attainment") +
  ylab("Freq.") +
  ggtitle("Educational Attainment Distribution")
```



```{r kinship, fig.align='center', echo=F}
# For displaying purposes a charcter vector is created, that orders the levels
# by Frequency
ord <- as.character(
  arrange(data.frame(table(households$kinship)),
          desc(Freq))$Var1)

ggplot(aes(factor(kinship, levels = ord), y = ..count..), data = households) + 
  geom_histogram(fill = "#67a9cf") + 
  theme(axis.text.x=element_text(angle = 40, hjust = 1)) +
  xlab("Relationship with Household Head") +
  ylab("Freq.")
```

```{r houseten, fig.align='center', echo=F}
# For displaying purposes a charcter vector is created, that orders the levels
# by Frequency
ord <- as.character(
  arrange(data.frame(table(households$TVP)),
          desc(Freq))$Var1)

ggplot(aes(factor(TVP, levels = ord), y = 100 * ..count.. / sum(..count..)),
       data = households) + 
  geom_histogram(fill = "#67a9cf") + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) +
  xlab("Kind of Household Tenure") +
  ylab("Percentage")
```

```{r houseinc, echo=F, fig.align='center'}

houseinc <- households %>% 
  subset(person.id == 1 & !is.na(INGDHOG_HD_AI)) %>% 
  select(home.id, INGDHOG_HD_AI)

ggplot(aes(INGDHOG_HD_AI), data = houseinc) +
  geom_histogram(fill = "#67a9cf", binwidth = 100) +
  xlab("Household Monthly Income (US$)") +
  ylab("Frequency")
```

Let's change the x scale so we can see more details on the distribution if the
household's income.

```{r houseinc_log_den, echo=F, fig.align='center'}
ggplot(aes(INGDHOG_HD_AI), data = houseinc) +
  geom_density(binwidth = 0.1, fill = "#67a9cf") +
  scale_x_continuous(tran="log1p", breaks=c(3, 420, 576, 739, 908, 1110, 1370,
                                            1710, 2310, 3610, 53300)) +
  xlab("Household Monthly Income (US$)") +
  ylab("Density") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r houseinc_det, echo=F, fig.align='center'}
ggplot(aes(INGDHOG_HD_AI), data = houseinc) +
  geom_histogram(binwidth = 100, fill = "#67a9cf") +
  scale_x_continuous(breaks=c(3, 420, 576, 739, 908, 1110, 1370,
                              1710, 2310, 3610),
                     limits=c(0,3610)) +
  xlab("Household Monthly Income (US$)") +
  ylab("Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r incquant_calc}
decil <- quantile(houseinc$INGDHOG_HD_AI, probs = seq(0, 1, 0.1), na.rm = T)

decil[1] <- 0 
decil[11] <- decil[11] + 100

households$income.dec <- cut(households$INGDHOG_HD_AI, decil, right = F)
houseinc$income.dec <- cut(houseinc$INGDHOG_HD_AI, decil, right = F)

levels(houseinc$income.dec) <- c(
  "US$3 to US$419", "US$420 to US$575", "US$576 to US$738", "US$739 to US$907",
  "US$908 to US$1109", "US$1110 to US$1369", "US$1370 to US$1709", 
  "US$1710 to US$2309", "US$2310 to US$3609", "US$3610 and Up" )
levels(households$income.dec) <- levels(houseinc$income.dec)

indec <- subset(houseinc, !is.na(income.dec)) %>% 
  group_by(income.dec) %>% 
  summarise(Total = sum(INGDHOG_HD_AI, na.rm = T))
```

```{r checkincquant_plot, echo=FALSE, fig.align='center'}
ggplot(aes(income.dec), data = houseinc) +
  geom_histogram(fill = "#67a9cf") +
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) +
  xlab('Household Incomes\' Deciles') +
  ylab('Household by Decile') +
  ggtitle('Checking Deciles')
```


```{r totincquant_plot, echo=FALSE, fig.align='center'}
ggplot(aes(income.dec, y = 100 * Total / sum(Total)), data = indec) +
  geom_bar(stat = "identity", fill = "#67a9cf") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab('Household Incomes\' Deciles') +
  ylab('Percentage of the Total Household Income') +
  ggtitle('Household Income Distribution by Deciles')
```

So, while the mean household income is US$`r summary(houseinc$INGDHOG_HD_AI)[4]`
the median is at US$`r summary(houseinc$INGDHOG_HD_AI)[3]`. How it does
compare with other countries?

```{r houseinc_summ, echo=F}
summary(houseinc$INGDHOG_HD_AI)
```

```{r inhab_sum, echo=F, fig.align='center'}
inhab <- households %>%
  subset(person.id == 1, select=c("home.id", "num.inhabitants"))

ggplot(aes(as.factor(num.inhabitants)), data = inhab) +
  geom_histogram(fill = "#67a9cf") +
  scale_x_discrete() +
  xlab('Number of Inhabitants by Household') +
  ylab('Frequency')
```

```{r inhab_summ}
summary(inhab$num.inhabitants)
```

```{r edudep, fig.align='center'}
ord <- as.character(
  arrange(data.frame(table(households$EDUDEPENDENCIA)),
          desc(Freq))$Var1)

ggplot(aes(factor(EDUDEPENDENCIA, levels=ord)), data = households) +
  geom_histogram(fill = "#67a9cf") + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) +
  xlab('Educational Institution Type (private/public)') +
  ylab('Frequency')
```

```{r edudep2, fig.align='center'}
ggplot(aes(factor(EDUDEPENDENCIA, levels = ord), y = 100 * ..count.. / sum(..count..)),
       data = households[households$EDUDEPENDENCIA %in% ord[c(3,2,5)], ]) +
  geom_histogram(fill = "#67a9cf") +
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) +
  xlab('Primary Education Type (private/public)') +
  ylab('Percentage')
```

```{r health_sum}
summary(subset(households, !is.na(SALUD))$SALUD)
```

```{r health, fig.align='center'}
ggplot(aes(SALUD), data = subset(households, !is.na(SALUD))) +
  geom_histogram(fill = "#67a9cf", binwidth = 10) +
  xlab('Health Expenditure (US$)') +
  ylab('Frequency')
```

```{r health_log, fig.align='center'}
ggplot(aes(SALUD), data = subset(households, !is.na(SALUD))) +
  geom_histogram(fill = "#67a9cf", binwidth = 0.2) +
  scale_x_continuous(trans="log1p", breaks=c(5,50,100,200,1000,2000)) +
  xlab('Health Expenditure (US$)') +
  ylab('Frequency')
```



# Bivariate Analysis.

We can arrange a little bit more this plot and create a _population pyramid_:

```{r age_pyr,fig.align = 'center',fig.width = 8, echo = F, warning = F}
ggplot() + 
  geom_histogram(aes(x = age, fill = gender), binwidth = 1, 
                 data = subset(households, gender == "Women" & age >= 0)) + 
  geom_histogram(aes(x = age, fill = gender, y = ..count.. * -1.), binwidth = 1, 
                 data = subset(households, gender == "Men" & age >= 0)) + 
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(breaks = seq(0, 105, 5)) +
  scale_y_continuous(limits = c(-400, 400)) +
  coord_flip()

gen_tab <- prop.table(table(households$gender))
```

The peaks seem to change for each gender! We can also notice that there are more
women (`r format(100 * gen_tab[[2]][1], digits=3)`%) than men 
(`r format(100 * gen_tab[[1]][1], digits=3)`%). Are the gender's average age
different?

```{r gender_age, fig.align='center', fig.width=8, echo=F}
age_hist + geom_density(aes(color=gender), binwidth=1) + 
  scale_color_brewer(palette="Paired") +
  xlab("Age") +
  ylab("Density")
```

We see a difference in the average age for both gender, with males having an
overall younger population.

```{r, results='asis', echo=F}
age_gen <- subset(households, age >= 0, select=c("age", "gender"))
tc <- do.call(rbind, by(age_gen$age, age_gen$gender, summary))
pandoc.table(tc, split.cells=5)
```

Let's test if the difference in statistical significant by using the Wilcoxon 
Rank Test:

```{r results='asis', echo=FALSE}
pander(wilcox.test(age ~ gender, age_gen), table.style="multiline")
```

What about the education attainment distribution? We will study the distribution
using an stacked histogram, so we can study at the same time if there are any
significant differences between genders.

```{r fig.align='center', echo=F}

edugen_plot <- ggplot(aes(edu.level), data=households)

edugen_plot + 
  geom_histogram(aes(fill=gender)) + 
  scale_x_discrete(labels = seq(0,15,1)) +
  scale_fill_brewer(palette="Paired")
```

We see a pick in the distribution at category 5, which correspond to the primary
education. This doesn't mean that most of the population only reach primary
school: we have not removed the school-age population. We could use two 
variables to subset the data and include only the population that is no longer
studying:

* `edu.finish`: indicates wheter the person did or not finish the educational
  attainment reported.
* `age`: we subset only the population over 30 years old, assuming that most
  of the people is no longer studying at that age.

```{r fig.align='center', echo=FALSE}
edugen_plot2 <- ggplot(
  aes(edu.level, y=100 * ..count.. / sum(..count..)),
  data=subset(households, edu.finish == "Si"))

edugen_plot3 <- ggplot(
  aes(edu.level, y=100 * ..count../sum(..count..)),
  data=subset(households, age >= 30 & !is.na(edu.level)))

p1 <- edugen_plot2 + 
  geom_histogram(fill="#67a9cf") + 
  scale_x_discrete(breaks=0:15, drop=F) +
  scale_fill_brewer(palette="Paired") +
  geom_vline(xintercept=12.5) +
  coord_cartesian(ylim=c(0,32)) +
  ggtitle("Population with complete education.")+
  xlab("Educational attainment") +
  ylab("Percentage")

p2 <- edugen_plot3 + 
  geom_histogram(fill="#67a9cf") + 
  scale_x_discrete(labels = append(seq(0,15,1), "NA"), drop=F) +
  scale_fill_brewer(palette="Paired") +
  geom_vline(xintercept=12.5) +
  coord_cartesian(ylim=c(0,32))+
  ggtitle("Population over 30 years old.") +
  xlab("Educational attainment") +
  ylab("Percentage")

grid.arrange(p1, p2, ncol=1)
```

As shown in the [Introduction]

```{r fig.align='center', fig.width=10, fig.height=7, echo=F}
households$age.group <- cut(
  households$age, seq(1,101,10),
  labels=c("0-9 years","10-19 years","20-29 years","30-39 years","40-49 years",
           "50-59 years","60-69 years","70-79 years","80-89 years",
           "90-99 years"),
  right=F)

households$edu.cat <- ifelse(
  as.numeric(households$edu.level) > 11, "Tertiary", "No Tertiary")

cont_table <- as.data.frame(
  prop.table(
    table(households$age.group, households$edu.cat, households$gender),
    m=c(1)))

for (i in seq(1,nrow(cont_table),1)) {
  cont_table[i,"pos"] <- ifelse(
    cont_table[i,"Var3"] == "Men",
    cont_table[i,"Freq"]*0.85,
    (cont_table[i,"Freq"] + cont_table[i-20,"Freq"]) * 0.9)
  } 

ggplot(aes(Var2, y=100 * Freq), data=cont_table) + 
  geom_bar(aes(fill=Var3), stat="identity") + 
  scale_x_discrete() + 
  xlab("Educational Attainment") +
  ylab("Percentage by age group") +
  scale_fill_brewer(palette="Paired") +
  geom_text(
    aes(label=paste(format(100*Freq, digits=1), "%"), y=100*pos), size=4.) + 
  facet_wrap(~Var1,scales="free_y")
```



```{r echo=F, fig.align='center'}
ggplot(aes(age, INGDA), data=subset(households, age > 0 & INGDA > 0)) +
  geom_jitter(alpha=0.4) +
  scale_y_log10(breaks=c(30000))

ggplot(aes(age, INGDA), data=subset(households, age > 0 & INGDA > 0)) +
  geom_jitter(alpha=0.4) +
  coord_trans(ytrans="log1p")
```

```{r warning=F, echo=F, fig.align='center'}
ggplot(aes(INGDHOG_HD, GASTOT_FNR), data=subset(households, household.head == 1)) +
  geom_point(alpha=0.3) + scale_x_log10(breaks=c(100,1000,10000)) + geom_smooth()
```

```{r warning=F, echo=F, fig.align='center'}
p1 <- ggplot(aes(INGDHOG_HD, INGDHOG_HD - GASTOT_FNR), data=subset(households, household.head == 1)) +
  geom_point(alpha=0.3) + scale_x_log10(breaks=c(100,1000,10000)) + geom_smooth() +
  coord_cartesian()

p2 <- ggplot(aes(INGDHOG_HD, INGDHOG_HD - GASTOT_FNR), data=subset(households, household.head == 1)) +
  geom_point(alpha=0.3) + scale_x_log10(breaks=c(100,1000,10000)) + geom_smooth() +
  coord_cartesian(xlim=c(100,10000), ylim=c(-1000,1000))

grid.arrange(p1, p2, ncol=1)
```

```{r echo=F, fig.align='center'}
ggplot(aes(income.dec, INGHOG_HD - GASTOT_FNR), data = subset(households, person.id == 1)) + geom_hline(yintercept=0) +
  geom_jitter(alpha=0.1) + geom_boxplot()

ggplot(aes(income.dec, GASTOT_FNR / INGHOG_HD), data = subset(households, person.id == 1 & GASTOT_FNR / INGHOG_HD <= 10)) + geom_hline(yintercept=1) +
  geom_jitter(alpha=0.1) + geom_boxplot() +  scale_y_continuous(trans='log1p')

```

What are households expending on?

```{r fig.align='center', fig.width=10}
tabex <- expenses %>% group_by(GLOSA) %>% summarise(expend = sum(GASTO))
usar <- as.character(as.data.frame(tabex[order(-tabex$expend)[2:33][-17][-14],])[,1])

highexp <- subset(expenses, GLOSA %in% usar)

tabexp2 <- highexp %>% group_by(GLOSA) %>% summarise(med = median(GASTO))
usar2 <- as.character(as.data.frame(tabexp2[order(-tabexp2$med),])[,1])

ggplot(aes(factor(GLOSA, levels = usar2), GASTO), data = highexp) + 
  geom_jitter(alpha = 0.3, color = "#67a9cf") + 
  geom_boxplot(alpha = 0.8) + 
  scale_y_log10() + 
  scale_x_discrete(labels = 1:30) +
  xlab('Expenditure Category') +
  ylab('Expenditure Amount (US$)')

```